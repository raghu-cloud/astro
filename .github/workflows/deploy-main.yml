name: Deploy to astro_ai_main EC2

on:
  push:
    branches: [ main ]

jobs:
   deploy:
     runs-on: ubuntu-latest
     steps:
       - name: Checkout code
         uses: actions/checkout@v3
 
       - name: Configure AWS credentials
         uses: aws-actions/configure-aws-credentials@v1
         with:
           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
           aws-region: ap-south-1
 
       - name: Deploy to EC2
         uses: appleboy/ssh-action@master
         with:
           host: 3.7.63.244
           username: ubuntu
           key: ${{ secrets.EC2_PROD_SSH_KEY }}
           script: |
             cd /home/ubuntu/backend
             git fetch origin main
             git reset --hard origin/main
             
             # Stop and disable the systemd service
             sudo systemctl stop automatic.service || true
             sudo systemctl disable automatic.service || true
             
             # Start Docker deployment
             source env/bin/activate
             pip install -r requirements.txt
             python manage.py migrate --skip-checks
             sudo docker compose down
             sudo docker compose up -d --build

              # Verify deployment
             sudo docker compose ps
             sudo docker compose logs

